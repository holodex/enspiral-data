#!/usr/bin/env node

var Path = require('path')
var fs = require('fs')
var levelup = require('levelup')
var levelws = require('level-ws')
var fsdown = require('fsdown')
var forEach = require('lodash.foreach')
var assign = require('lodash.assign')
var through = require('through2')
var forkable = require('forkable')

var migratePath = process.argv[2]
if (migratePath == null) {
  console.log("migrate path not given!")
  process.exit(1)
}

var migrate = require(
  Path.join(process.cwd(), migratePath)
)

if (typeof migrate !== 'function') {
  console.log("migrate is not a function")
  process.exit(1)
}

var inputs = {}

// get starting db inputs
fs.readdirSync('.')
.filter(function (path) { return Path.extname(path) === '.csv'})
.forEach(function (path) {
  var type = Path.basename(path, '.csv')
  inputs[type] = getDb(type)
})

var toMigrate = through.obj()

// read
forEach(inputs, function (db, type) {
  db.createReadStream()
  .pipe(through.obj(function (row, enc, cb) {
    assign(row.value, { type: type })
    cb(null, row)
  })).pipe(toMigrate)
})

// migrate
var migrated = toMigrate.pipe(migrate())

var outputs = {} 

// get ending db outputs
forkable(
  migrated
)
.fork(function (row) {
  var type = row.value.type
  delete row.value.type
  if (outputs[type] == null) {
    outputs[type] = getDb(type, true)
  }
  return type
})
.pipe(function (type) {
  return outputs[type].createWriteStream({ valueEncoding: 'json' })
})

function getDb (type, isTmp) {
  var dir = isTmp ? 'tmp' : ''
  var path = Path.join(process.cwd(), dir, type + '.csv')
  return levelws(levelup(path, {
    db: fsdown({ codec: 'csv', keyAttribute: 'id' })
  }))
}
